apiRevision: edurata.io/v1
name: delete-microapp-user
title: Deletes a user from a microapp
description: |
  Deletes a user from several systems after a webhook call from tally.
interface:
  inputs:
    properties:
      app_name:
        type: string
        description: |
          The name of the app.
        example: "Accounting bot"
      app_resub_link:
        type: string
        description: |
          The link to resubscribe to the app.
        example: "https://contact.edurata.com/accountingbot"
      sender:
        type: string
        description: |
          The email address from which the oauth email will be sent.
        example: "accountingbot@edurata.com"
      peopleTableId:
        type: string
        description: |
          The base id + table_id from which to take the people
      data:
        type: object
        properties:
          fields:
            type: array
            items:
              type: object
              properties:
                label:
                  type: string
                value:
                  type: string
steps:
  extract-data-from-event:
    runtime: python3_10
    code: |
      import urllib.parse

      def handler(inputs):
          # Assuming 'inputs' is a dictionary and 'inputs["data"]' is a list of dictionaries
          uri_encoded_email = urllib.parse.quote(inputs["data"][1]["value"])
          uri_encoded_name = urllib.parse.quote(inputs["name"])
          return {
              "name": inputs["data"][0]["value"],
              "email": inputs["data"][1]["value"],
              "uriEncodedEmail": uri_encoded_email,
              "uriEncodedId": uri_encoded_name + "-" + uri_encoded_email
          }
    props:
      data: ${inputs.data.fields}
      name: ${inputs.app_name}
  delete-environment:
    source:
      repoUrl: "https://github.com/Edurata/edurata-functions.git"
      path: general/axios
    props:
      url: ${meta.apiUrl}/environment/byname/${extract-data-from-event.uriEncodedId}
      method: DELETE
      headers:
        Authorization: "Bearer ${secrets.EDURATA_API_KEY}"
  delete-deployment:
    source:
      repoUrl: "https://github.com/Edurata/edurata-functions.git"
      path: general/axios
    props:
      url: ${meta.apiUrl}/deployment/byname/${extract-data-from-event.uriEncodedId}
      method: DELETE
      headers:
        Authorization: "Bearer ${secrets.EDURATA_API_KEY}"
  get-person-data:
    source:
      repoUrl: "https://github.com/Edurata/edurata-functions.git"
      path: general/axios
    props:
      url: 'https://api.airtable.com/v0/${inputs.peopleTableId}?filterByFormula=AND(NOT(disabled),{email}="${inputs.userEmail}")'
      headers:
        Authorization: "Bearer ${secrets.AIRTABLE_API_KEY}"
  delete-airtable-record:
    source:
      repoUrl: "https://github.com/Edurata/edurata-functions.git"
      path: general/axios
    props:
      url: https://api.airtable.com/v0/${inputs.peopleTableId}/${get-person-data.response.data.records[0].id}
      headers:
        Authorization: "Bearer ${secrets.AIRTABLE_API_KEY}"
  send-delete-email:
    source:
      repoUrl: "https://github.com/Edurata/edurata-functions.git"
      path: etl/load/send-ses
    props:
      _delete-deployment: ${delete-deployment}
      _delete-environment: ${delete-environment}
      _delete-airtable-record: ${delete-airtable-record}
      sender: ${inputs.sender}
      to: ${extract-data-from-event.email}
      subject: "${inputs.app_name}: All resources for your subscription were deleted"
      html_body: >
        Hey ${extract-data-from-event.name}!,
        <br><br>
        We have deleted all resources related to your subscription.

        If you want to start a new subscription visit [this link](${inputs.app_resub_link}).

        All the best,
        The Edurata team
        <br><br>
      AWS_ACCESS_KEY_ID: ${secrets.SHORT_STORY_KEY}
      AWS_SECRET_ACCESS_KEY: ${secrets.SHORT_STORY_SECRET}
