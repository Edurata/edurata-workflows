apiRevision: edurata.io/workflow/v1
name: invoice-processor
title: Invoice Processor
schedule: 0 9 * * *
description: The workflow automates the process of scanning inbox emails for invoices, extracting and downloading attachments, tagging emails in Gmail, saving invoices to a structured Google Drive folder, and forwarding them to a specified email address. It retrieves user data from Airtable API and merges it with base configuration. It creates labels in Gmail for success, failure, and skip tags and retrieves label IDs from Gmail's API. The workflow also retrieves the ten most recent emails from the user's Gmail account that were received after January 1, 2021, have a PDF attachment, and do not have specific labels. It then fetches detailed information for each new email message, filters attachments, downloads and saves them, forwards a PDF by making a POST request to the Gmail API, creates a new folder path in Google Drive, uploads files to Google Drive, and automates the process of tagging emails.
interface:
  inputs:
    properties:
      peopleTableId:
        type: string
        description: |
          The base id + table_id from which to take the people
      userEmail:
        type: string
        description: |
          The email address of the user
      config:
        type: object
        description: |
          The configuration of the invoice processor
        properties:
          gdriveFolderName:
            type: string
            description: |
              The Google Drive folder Name to save the invoices to
          forwardEmail:
            type: string
            description: |
              The email address to forward the invoices to
          successTag:
            type: string
            default: to-datev/processed
          failTag:
            type: string
            default: to-datev/failed
          skipTag:
            type: string
            default: to-datev/skipped
          invoiceTag:
            type: string
            default: Rechnungen
          additionalQuery:
            type: string
            description: |
              Additional query to filter the emails
            default: ""
    required:
      - config
      - userEmail
      - peopleTableId
inputs:
  config: ${variables.invoices_forward_config}
  peopleTableId: ${variables.accountingbot_people_table_id}
steps:
  get-people-data:
    description: This step retrieves data from an Airtable API for a specific user's email, provided the user is not disabled, using the Airtable API key for authorization.
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: general/axios
    props:
      url: https://api.airtable.com/v0/${inputs.peopleTableId}?filterByFormula=AND(NOT(disabled),{email}="${inputs.userEmail}")
      headers:
        Authorization: Bearer ${secrets.AIRTABLE_API_KEY}
  merge-config:
    description: This step is merging the user configuration data retrieved from the 'get-people-data' response with the base configuration input.
    runtime: python3_10
    code: |
      def handler(inputs):
          user_config = inputs["user_config"]
          base_config = inputs["base_config"]
          # merge both together
          merged = {**base_config, **user_config}
          return  {"config": merged}
    props:
      user_config: ${get-people-data.response.data.records[0].fields}
      base_config: ${inputs.config}
    interface:
      inputs:
        properties:
          user_config:
            type: object
            description: User specific configuration data
          base_config:
            type: object
            description: Base configuration data
        required:
          - user_config
          - base_config
      outputs:
        properties:
          merged_config:
            type: object
            description: Merged configuration data
  create-folders:
    description: This step creates folders in Outlook for success, failure, and skip tags, using Microsoft Graph API.
    optional: true
    foreach:
      - ${merge-config.config.successTag}
      - ${merge-config.config.failTag}
      - ${merge-config.config.skipTag}
      - ${merge-config.config.invoiceTag}
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: general/axios
    props:
      url: https://graph.microsoft.com/v1.0/me/mailFolders
      method: POST
      headers:
        Authorization: Bearer ${secrets.OUTLOOK_API_KEY}
      body:
        displayName: ${each}
      throwError: false
  get-folder-ids:
    description: This step retrieves the folder IDs from Outlook's API using Microsoft Graph API, depending on the creation of folders.
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: general/axios
    props:
      method: GET
      url: https://graph.microsoft.com/v1.0/me/mailFolders
      headers:
        Authorization: Bearer ${secrets.OUTLOOK_API_KEY}
      __create-folders: ${create-folders}
  transform-tags-to-folder-ids:
    description: This step transforms tags into folder IDs, using the folder IDs obtained from the 'get-folder-ids' step and the tags specified in the merge-config configuration (successTag, failTag, skipTag).
    runtime: python3_10
    code: |
      def handler(inputs):
          folder_ids = {}
          folders = inputs["get-folder-ids"]["response"]["data"]["value"]
          folder_map = {folder["displayName"]: folder["id"] for folder in folders}
          
          success_tag = inputs["successTag"]
          fail_tag = inputs["failTag"]
          skip_tag = inputs["skipTag"]
          invoice_tag = inputs["invoiceTag"]
          
          # Check if folders exist
          missing_folders = []
          if success_tag not in folder_map:
              missing_folders.append(success_tag)
          else:
              folder_ids["successTag"] = folder_map[success_tag]
              
          if fail_tag not in folder_map:
              missing_folders.append(fail_tag)
          else:
              folder_ids["failTag"] = folder_map[fail_tag]
              
          if skip_tag not in folder_map:
              missing_folders.append(skip_tag)
          else:
              folder_ids["skipTag"] = folder_map[skip_tag]
              
          if invoice_tag not in folder_map:
              missing_folders.append(invoice_tag)
          else:
              folder_ids["invoiceTag"] = folder_map[invoice_tag]
          
          if missing_folders:
              available_folders = list(folder_map.keys())
              raise Exception(f"Required folders not found: {missing_folders}. Available folders: {available_folders}")
          
          return {"folder_ids": folder_ids}
    props:
      get-folder-ids: ${get-folder-ids}
      successTag: ${merge-config.config.successTag}
      failTag: ${merge-config.config.failTag}
      skipTag: ${merge-config.config.skipTag}
      invoiceTag: ${merge-config.config.invoiceTag}
    interface:
      inputs:
        properties:
          get-folder-ids:
            type: object
            description: Object containing folder ids
          successTag:
            type: string
            description: Tag to be used for successful operations
          failTag:
            type: string
            description: Tag to be used for failed operations
          skipTag:
            type: string
            description: Tag to be used for skipped operations
          invoiceTag:
            type: string
            description: Tag to be used for invoice folder
        required:
          - get-folder-ids
          - successTag
          - failTag
          - skipTag
          - invoiceTag
      outputs:
        properties:
          folder_ids:
            type: object
            description: Object containing transformed tags to folder ids
            properties:
              successTag:
                type: string
              failTag:
                type: string
              skipTag:
                type: string
              invoiceTag:
                type: string
        required:
          - folder_ids
  get-new-mails-without-tag:
    description: This step is retrieving emails from the "Rechnungen" folder in the user's Outlook account using Microsoft Graph API.
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: general/axios
    props:
      method: GET
      url: https://graph.microsoft.com/v1.0/me/mailFolders/${transform-tags-to-folder-ids.folder_ids.invoiceTag}/messages
      headers:
        Authorization: Bearer ${secrets.OUTLOOK_API_KEY}
      params:
        $top: 100
        $orderby: receivedDateTime desc
      __transform-tags-to-folder-ids: ${transform-tags-to-folder-ids}
  get-mails-info:
    description: This step fetches detailed information for each new email message from the Outlook API, using the message ID, with attachments and body content.
    foreach: ${get-new-mails-without-tag.response.data.value}
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: general/axios
    props:
      url: https://graph.microsoft.com/v1.0/me/messages/${each.id}
      headers:
        Authorization: Bearer ${secrets.OUTLOOK_API_KEY}
      params:
        $expand: attachments
      __get-new-mails-without-tag: ${get-new-mails-without-tag}
  filter-attachments:
    description: This step involves filtering attachments from the data received from the 'get-mails-info' responses.
    source:
      repoUrl: https://github.com/Edurata/edurata-workflows.git
      path: apps/mail/invoice-forwarder/filter-attachments
    props:
      messages: ${get-mails-info[*].response.data}
  download-attachments:
    description: This step is downloading attachments from specific messages using the Outlook API, iterating over each filtered attachment from the previous step.
    foreach: ${filter-attachments.filtered_attachments}
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: general/axios
    props:
      url: https://graph.microsoft.com/v1.0/me/messages/${each.message_id}/attachments/${each.attachment_id}/$value
      headers:
        Authorization: Bearer ${secrets.OUTLOOK_API_KEY}
      streamToFile: true
      streamToFileName: ${each.attachment_id}.pdf
  forward-pdf:
    description: This step forwards PDF attachments using the Outlook email function.
    if:
      "!!": ${merge-config.config.forwardEmail}
    else: success
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: etl/load/send-outlook-email
    props:
      OUTLOOK_API_KEY: ${secrets.OUTLOOK_API_KEY}
      userEmail: ${inputs.userEmail}
      recipient: ${merge-config.config.forwardEmail}
      subject: "Invoice"
      body: "Please find the attached invoices."
      attachments: ${download-attachments[*].response.file}
  get-folder-id:
    description: This step involves obtaining the folder ID, provided that the Google Drive folder name in the merge-config is not null.
    runtime: python3_10
    if:
      "!!": ${merge-config.config.gdriveFolderName}
    code: |
      import datetime
      def handler(inputs):
          # today date like 2021-01-01
          today = datetime.datetime.now().strftime("%Y-%m-%d")
          return {"folder_name": today}
    interface:
      inputs:
        properties:
          merge-config:
            type: object
            properties:
              config:
                type: object
                properties:
                  gdriveFolderName:
                    type: string
                required:
                  - gdriveFolderName
            required:
              - config
        required:
          - merge-config
      outputs:
        properties:
          folderId:
            type: string
        required:
          - folderId
  create-folderpath:
    if:
      "!!": ${filter-attachments.filtered_attachments}
    description: This step creates a new folder path in Google Drive using the provided OAuth token and folder name, only if there are filtered attachments present.
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: etl/load/create-gdrive-folderpath
    props:
      OAUTH_TOKEN: ${secrets.G_DRIVE}
      folder_path: ${merge-config.config.gdriveFolderName}/${get-folder-id.folder_name}
  get-parent-folder-id:
    description: This step is retrieving the ID of a parent folder from Google Drive using a GET request, with the folder name and API key as parameters.
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: general/axios
    props:
      method: GET
      url: https://www.googleapis.com/drive/v3/files
      headers:
        Authorization: Bearer ${secrets.G_DRIVE}
      params:
        q: name='${get-folder-id.folder_name}' and mimeType='application/vnd.google-apps.folder'
      __create-folderpath: ${create-folderpath}
  upload-files-in-gdrive:
    description: This step uploads files to Google Drive, specifically to a parent folder, by iterating through each downloaded attachment file, using the Gmail API key for authorization.
    foreach: ${download-attachments[*].response.file}
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: clients/gdrive
    props:
      OAUTH_TOKEN: ${secrets.G_DRIVE}
      action: upload
      upload_file_name: ${filter-attachments.filtered_attachments[each.index].attachment_id}
      parent_folder_id: ${get-parent-folder-id.response.data.files[0].id}
      file_path: ${each}
  map-messages-to-folders:
    description: This step involves mapping messages to folders based on the properties of new emails, filtered attachments, and specific success, fail, and skip folder destinations.
    runtime: python3_10
    code: |
      def handler(inputs):
        message_to_folders = []
        processed_conversations = set()
        
        for message in inputs["all_messages"]:
            conversation_id = message["conversationId"]
            message_id = message["id"]

            # Only process the first message in each conversation
            if conversation_id in processed_conversations:
                continue
            
            processed_conversations.add(conversation_id)

            is_in_filtered_attachments = any(
                attachment["message_id"] == message_id
                for attachment in inputs["filtered_attachments"]
            )
            folder_id = inputs["successFolder"] if is_in_filtered_attachments else inputs["skipFolder"]
            
            message_to_folders.append({
                "conversationId": conversation_id,
                "messageId": message_id,
                "folderId": folder_id
            })

        return {"mapped_messages": message_to_folders}
    props:
      all_messages: ${get-new-mails-without-tag.response.data.value}
      filtered_attachments: ${filter-attachments.filtered_attachments}
      successFolder: ${transform-tags-to-folder-ids.folder_ids.successTag}
      failFolder: ${transform-tags-to-folder-ids.folder_ids.failTag}
      skipFolder: ${transform-tags-to-folder-ids.folder_ids.skipTag}
    interface:
      inputs:
        properties:
          all_messages:
            type: array
            items:
              type: object
          filtered_attachments:
            type: array
            items:
              type: object
          successFolder:
            type: string
          failFolder:
            type: string
          skipFolder:
            type: string
        required:
          - all_messages
          - filtered_attachments
          - successFolder
          - failFolder
          - skipFolder
      outputs:
        properties:
          mapped_messages:
            type: array
            items:
              type: object
        required:
          - mapped_messages
  move-emails-to-folders:
    description: This step automates the process of moving emails to folders by posting a request to the Outlook API for each message specified in the 'map-messages-to-folders' object, using the 'OUTLOOK_API_KEY' for authorization.
    foreach: ${map-messages-to-folders.mapped_messages}
    source:
      repoUrl: https://github.com/Edurata/edurata-functions.git
      path: general/axios
    props:
      method: POST
      url: https://graph.microsoft.com/v1.0/me/messages/${each.messageId}/move
      headers:
        Authorization: Bearer ${secrets.OUTLOOK_API_KEY}
      body:
        DestinationId: ${each.folderId}
